name: Deploy n8n to Fly.io

on:
  push:
    branches:
      - main   # ถ้าใช้ branch อื่น เปลี่ยนตรงนี้

jobs:
  deploy:
    name: Deploy app to Fly.io
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      # 1) ตรวจว่ามี app แล้วหรือยัง ถ้าไม่มีให้สร้าง
      # - name: Ensure Fly app exists
      #   run: |
      #     set -e
      #     APP_NAME="n8n-test-poxxba"

      #     echo "Checking if app $APP_NAME exists..."
      #     if flyctl apps list | grep -q "$APP_NAME"; then
      #       echo "App $APP_NAME already exists. Skipping create."
      #     else
      #       echo "App $APP_NAME not found. Creating..."
      #       flyctl apps create "$APP_NAME"
      #     fi
      #   env:
      #     FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      # 2) ตรวจว่า volume n8n_data มีหรือยัง ถ้าไม่มีให้สร้าง
      - name: Ensure volume exists
        run: |
          set -e
          APP_NAME="n8n-test-poxxba"
          VOLUME_NAME="n8n_data"
          REGION="sin"

          echo "Checking if volume $VOLUME_NAME exists for app $APP_NAME..."
          if flyctl volumes list --app "$APP_NAME" | grep -q "$VOLUME_NAME"; then
            echo "Volume $VOLUME_NAME already exists. Skipping create."
          else
            echo "Volume $VOLUME_NAME not found. Creating in region $REGION..."
            flyctl volumes create "$VOLUME_NAME" \
              --app "$APP_NAME" \
              --region "$REGION" \
              --size 1 \
              --yes
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      # 3) (ถ้าใช้ Basic Auth) set secrets ให้ n8n จาก GitHub Secrets
      #    ถ้าไม่ใช้ Basic Auth สามารถลบบล็อกนี้ออกได้เลย
      # - name: Sync n8n secrets (optional)
      #   if: ${{ secrets.N8N_BASIC_AUTH_PASSWORD != '' && secrets.N8N_ENCRYPTION_KEY != '' }}
      #   run: |
      #     set -e
      #     APP_NAME="n8n-test-poxxba"

      #     echo "Setting n8n secrets from GitHub to Fly..."
      #     flyctl secrets set \
      #       N8N_BASIC_AUTH_PASSWORD="${N8N_BASIC_AUTH_PASSWORD}" \
      #       N8N_ENCRYPTION_KEY="${N8N_ENCRYPTION_KEY}" \
      #       --app "$APP_NAME"
      #   env:
      #     FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      #     N8N_BASIC_AUTH_PASSWORD: ${{ secrets.N8N_BASIC_AUTH_PASSWORD }}
      #     N8N_ENCRYPTION_KEY: ${{ secrets.N8N_ENCRYPTION_KEY }}

      # 4) Deploy ตาม fly.toml
      - name: Deploy to Fly
        run: flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
